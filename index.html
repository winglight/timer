<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B82Q8E53ZL"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MEASUREMENT_ID');
</script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>呼吸练习 10 分钟</title>
<style>
html, body { height: 100%; margin: 0; }
body { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; background: #ffffff; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding: 16px; }
.panel { display: flex; flex-direction: column; align-items: center; gap: 12px; color: #0f4c81; }
.time-left { font-size: 32px; font-weight: 700; color: #0f4c81; }
.controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.controls label { display: flex; align-items: center; gap: 8px; font-size: 14px; }
.controls input[type="range"] { width: 180px; accent-color: #0f4c81; }
.btn { background: #0f4c81; color: #fff; border: none; padding: 8px 16px; border-radius: 8px; font-size: 16px; cursor: pointer; }
.wrap { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
.circle { position: relative; width: 240px; height: 240px; border-radius: 50%; background: #a7d8f0; display: flex; align-items: center; justify-content: center; transform: scale(0.7); transition: transform 4s ease-in-out; will-change: transform; box-shadow: 0 8px 24px rgba(167, 216, 240, 0.6); }
.circle::before { content: ""; position: absolute; inset: -28px; border-radius: 50%; pointer-events: none; z-index: -1; background: radial-gradient(circle at center, rgba(167,216,240,0.65) 30%, rgba(167,216,240,0.35) 65%, rgba(255,255,255,1) 100%); filter: blur(0.6px); display: none; }
.wave-svg { position: absolute; top: -56px; left: -56px; width: 352px; height: 352px; pointer-events: none; z-index: -1; filter: blur(0.6px); overflow: visible; }
.circle.vibrating .wave-svg { animation: ringPulse 2s ease-in-out infinite; }
.github-link { position: fixed; bottom: 20px; right: 20px; width: 40px; height: 40px; opacity: 0.6; transition: opacity 0.3s; z-index: 1000; color: #0f4c81; }
.github-link:hover { opacity: 1; }
.github-link svg { width: 100%; height: 100%; fill: currentColor; }
@keyframes ringPulse {
  0%   { transform: scale(1); opacity: 0.95; }
  50%  { transform: scale(1.08); opacity: 1; }
  100% { transform: scale(1); opacity: 0.95; }
}
.label { font-size: 32px; color: #0f4c81; letter-spacing: 1px; }
</style>
</head>
<body>
<div class="panel">
  <div class="controls">
    <label>吸时长
      <input id="inhaleRange" type="range" min="1" max="20" step="1" value="4">
      <span id="inhaleVal">4</span>s
    </label>
    <label>呼时长
      <input id="exhaleRange" type="range" min="1" max="30" step="1" value="6">
      <span id="exhaleVal">6</span>s
    </label>
    <label>暂停时长
      <input id="pauseRange" type="range" min="0" max="15" step="1" value="0">
      <span id="pauseVal">0</span>s
    </label>
    <button id="toggleBtn" class="btn">开始</button>
  </div>
</div>
<div class="time-left">剩余时间：<span id="remaining">10:00</span></div>
<div class="wrap">
  <div id="circle" class="circle">
    <svg class="wave-svg" viewBox="0 0 296 296">
      <path id="wavePath" fill="#8dc8ea" d="" />
    </svg>
    <div id="label" class="label"></div>
  </div>
</div>
<script>
const circle = document.getElementById('circle');
const label = document.getElementById('label');
const inhaleRange = document.getElementById('inhaleRange');
const exhaleRange = document.getElementById('exhaleRange');
const pauseRange = document.getElementById('pauseRange');
const inhaleVal = document.getElementById('inhaleVal');
const exhaleVal = document.getElementById('exhaleVal');
const pauseVal = document.getElementById('pauseVal');
const remainingEl = document.getElementById('remaining');
const toggleBtn = document.getElementById('toggleBtn');

function formatTime(s){ const m = Math.floor(s/60); const ss = s%60; return String(m).padStart(2,'0') + ':' + String(ss).padStart(2,'0'); }
function getInhale(){ return parseInt(inhaleRange.value,10); }
function getExhale(){ return parseInt(exhaleRange.value,10); }
function getPause(){ return parseInt(pauseRange.value,10); }

const SETTINGS_KEY = 'breath_settings';
function saveSettings(){
  const data = { inhale: getInhale(), exhale: getExhale(), pause: getPause() };
  try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(data)); } catch(e){}
}
function loadSettings(){
  try {
    const raw = localStorage.getItem(SETTINGS_KEY);
    if (raw){
      const data = JSON.parse(raw);
      if (typeof data.inhale === 'number') inhaleRange.value = String(data.inhale);
      if (typeof data.exhale === 'number') exhaleRange.value = String(data.exhale);
      if (typeof data.pause === 'number') pauseRange.value = String(data.pause);
    }
  } catch(e){}
  inhaleVal.textContent = inhaleRange.value;
  exhaleVal.textContent = exhaleRange.value;
  pauseVal.textContent = pauseRange.value;
}

let phase = 'inhale';
let secondsLeft = 0;
let sessionLeft = 600;
let running = false;
let timer = null;
let nextAfterPause = null;
let audioCtx = null;

function ensureAudio(){
  if (!audioCtx){
    try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){}
  }
}

function playBeep(durationSec){
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.value = 600;
  const t = audioCtx.currentTime;
  gain.gain.setValueAtTime(0.0001, t);
  gain.gain.exponentialRampToValueAtTime(0.06, t + 0.03);
  gain.gain.exponentialRampToValueAtTime(0.0001, t + durationSec);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start(t);
  osc.stop(t + durationSec + 0.05);
}

function playPhaseTone(name){
  const d = name === 'pause' ? 0.4 : 1.2;
  playBeep(d);
}

function startPhase(name){
  phase = name;
  if (name === 'pause'){
    secondsLeft = getPause();
    circle.classList.remove('vibrating');
    circle.style.transitionDuration = '0s';
    label.textContent = '停' + secondsLeft;
    if (running) playPhaseTone('pause');
    return;
  }
  secondsLeft = name === 'inhale' ? getInhale() : getExhale();
  circle.classList.add('vibrating');
  circle.style.transitionDuration = secondsLeft + 's';
  circle.style.transform = name === 'inhale' ? 'scale(1)' : 'scale(0.7)';
  label.textContent = (name === 'inhale' ? '吸' : '呼') + secondsLeft;
  if (running) playPhaseTone(name);
}

function tick(){
  sessionLeft -= 1;
  if (sessionLeft <= 0){
    finish();
    return;
  }
  remainingEl.textContent = formatTime(sessionLeft);
  secondsLeft -= 1;
  if (secondsLeft > 0){
    label.textContent = phase === 'pause' ? ('停' + secondsLeft) : ((phase === 'inhale' ? '吸' : '呼') + secondsLeft);
    return;
  }
  if (phase === 'pause'){
    startPhase(nextAfterPause || 'inhale');
    nextAfterPause = null;
    return;
  }
  const p = getPause();
  if (p > 0){
    nextAfterPause = (phase === 'inhale') ? 'exhale' : 'inhale';
    startPhase('pause');
    return;
  }
  startPhase((phase === 'inhale') ? 'exhale' : 'inhale');
}

function start(){
  if (sessionLeft <= 0){
    sessionLeft = 600;
    remainingEl.textContent = formatTime(sessionLeft);
  }
  if (secondsLeft <= 0){
    startPhase(phase);
  }
  running = true;
  toggleBtn.textContent = '停止';
  ensureAudio();
  timer = setInterval(tick, 1000);
  
  // Analytics
  if (typeof gtag === 'function') {
    gtag('event', 'start_practice', {
      inhale: getInhale(),
      exhale: getExhale(),
      pause: getPause()
    });
  }
}

function stop(){
  running = false;
  toggleBtn.textContent = '开始';
  if (timer){ clearInterval(timer); timer = null; }
  circle.classList.remove('vibrating');
  
  // Analytics
  if (typeof gtag === 'function') {
    gtag('event', 'stop_practice', {
      remaining_seconds: sessionLeft
    });
  }
}

function finish(){
  stop();
  label.textContent = '完成';
  circle.style.transitionDuration = '0.5s';
  circle.style.transform = 'scale(1)';
  remainingEl.textContent = '00:00';
  circle.classList.remove('vibrating');

  // Analytics
  if (typeof gtag === 'function') {
    gtag('event', 'complete_practice');
  }
}

loadSettings();
remainingEl.textContent = formatTime(sessionLeft);
label.textContent = '吸' + inhaleRange.value;

inhaleRange.addEventListener('input', () => {
  inhaleVal.textContent = inhaleRange.value;
  saveSettings();
  if (!running && sessionLeft > 0){
    if (phase === 'inhale') label.textContent = '吸' + inhaleRange.value;
  }
});

exhaleRange.addEventListener('input', () => {
  exhaleVal.textContent = exhaleRange.value;
  saveSettings();
  if (!running && sessionLeft > 0){
    if (phase === 'exhale') label.textContent = '呼' + exhaleRange.value;
  }
});

pauseRange.addEventListener('input', () => {
  pauseVal.textContent = pauseRange.value;
  saveSettings();
  if (!running && sessionLeft > 0){
    if (phase === 'pause') label.textContent = '停' + pauseRange.value;
  }
});

function generateWaves() {
   const path = document.getElementById('wavePath');
   const size = 352;
   const cx = size / 2;
   const cy = size / 2;
   const rBase = size / 2;
    const ringWidth = 56; 
    const maxWaveHeight = 24; // 限制波浪幅度，保留更多实心部分
    
    // Generate points
    const points = [];
    const segments = 24; // 稍微增加段数，使波浪更密集一些
    for (let i = 0; i < segments; i++) {
      const angle = (i / segments) * Math.PI * 2;
      
      // 使用正弦波产生规律起伏
      const sineVal = Math.sin(angle * 6); // 6个波峰
      const normalizedSine = (sineVal + 1) / 2; // 0 to 1
      
      // 让波浪在最外层波动
      // r 变化范围：rBase - maxWaveHeight 到 rBase
      const offset = normalizedSine * maxWaveHeight; 
      
      const r = rBase - offset;
      
      points.push({
        x: cx + Math.cos(angle) * r,
        y: cy + Math.sin(angle) * r
      });
    }
   
   // Close the loop
   // To make it smooth, we use Quadratic Bezier curves between midpoints of segments
   let d = "";
   
   // Find midpoints
   const midPoints = [];
   for (let i = 0; i < points.length; i++) {
     const p1 = points[i];
     const p2 = points[(i + 1) % points.length];
     midPoints.push({
       x: (p1.x + p2.x) / 2,
       y: (p1.y + p2.y) / 2
     });
   }
   
   // Start from first midpoint
   d += `M ${midPoints[0].x} ${midPoints[0].y}`;
   
   // Loop through points and draw Quad Bezier to next midpoint
   for (let i = 0; i < points.length; i++) {
     const p = points[(i + 1) % points.length]; // The control point (the actual point on ring)
     const nextMid = midPoints[(i + 1) % midPoints.length]; // The destination
     
     d += ` Q ${p.x} ${p.y}, ${nextMid.x} ${nextMid.y}`;
   }
   
   path.setAttribute('d', d);
 }

toggleBtn.addEventListener('click', () => {
  if (!running){ start(); } else { stop(); }
});

// Analytics: Settings changes
const trackSettingChange = (setting, value) => {
  if (typeof gtag === 'function') {
    gtag('event', 'update_setting', {
      setting_name: setting,
      value: value
    });
  }
};

inhaleRange.addEventListener('change', () => trackSettingChange('inhale', getInhale()));
exhaleRange.addEventListener('change', () => trackSettingChange('exhale', getExhale()));
pauseRange.addEventListener('change', () => trackSettingChange('pause', getPause()));

</script>
</body>
</html>